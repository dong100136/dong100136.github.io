<!DOCTYPE html><html lang="zh-Hans"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Talk is cheap,show me the code!"><title>【python爬虫】北邮教务系统 | Stone@bupt</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【python爬虫】北邮教务系统</h1><a id="logo" href="/.">Stone@bupt</a><p class="description">精通各种语言的helloword</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/resume"><i class="fa fa-sticky-note"> resume</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【python爬虫】北邮教务系统</h1><div class="post-meta">Sep 3, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><h1 id="缘起"><a href="#缘起" class="headerlink" title="缘起"></a>缘起</h1><p>作为一名狗剧控，最近突然萌发了想要看看豆瓣上电视剧评分的分布情况和比较一下国产电视剧和国外电视剧质量的比较（其实就是想黑国产电视剧），于是就萌发了想要写爬虫的想法，毕竟小的认为自己动手丰衣足食，掌握这一技能还是很方便的。在学习过程中有顺便黑了一下我邮的教务系统，写了这么一个小工具，通过这个小工具可以自动登录，查询课程表和查询成绩并计算平均成绩等。</p>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>毕竟现在python3越来越火了，就不要纠结在python2了，直接奔三。现在网上很多的爬虫资料还是用python2来写的，这难免会导致会碰到很多的坑。从python2到python3后，很多包都改变了，其中urllib改动还是较大的，python3中将2中常用的urllib和urllib2合并成了一个包，并且重写组织了包的结构层次。在urllib下分为四个包：error，request，response，parse，Request对象就是放在request包下的，urlencode放在parse下，这个需要注意一下。</p>
<p>但是最终没有采用urllib包，而是使用了requests包，我只能说这个包实在太方便了，在这里强烈推荐。</p>
<p>在访问教务系统时，有一个小的难点，就是会话的保持。一般来说，登录时需要使用到会话功能的。</p>
<h1 id="会话"><a href="#会话" class="headerlink" title="会话"></a>会话</h1><p>http是短连接访问，服务器是不会区分请求是否来自之前访问过的用户的，每次收到请求都会当做一个新的用户来处理。我们可以来看看登录的情况：一般来说登录的时候都需要生成一个验证码，当用户打开登录页面时，服务器会随机生成一个验证码和验证码对应的图片，然后将验证码的图片发送给客户端，验证码则会保存在服务器中，当用户填好表单后就将用户名，密码和验证码发送到服务器，服务器在将验证码进行对比，从而检验验证码的正确性。而服务器是怎么知道发来的表单和那个验证码相对应呢？这其中就使用到了cookie和会话技术。</p>
<p>当用户第一次访问一个网站时，服务器可以启动一个会话，在返回的response中加入一个随机生成的cookie，说白了cookie就是一个长的乱序序列，用来唯一标示一个用户，之后客户端每一次发送请求时就会在request带上这个cookie，这样服务器就知道是同一个用户访问服务器。</p>
<p>单独访问生成验证码的地址是没有意义。</p>
<h1 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h1><p>准确来说今天的这个程序不能算是一个爬虫，程序做的事情也很简单，只是下载一两个网页然后提取其中的一些内容进行了一下整理。但是既然看了爬虫的知识，这里就简单做一下总结。</p>
<p>对于一个爬虫来说，最重要的事情就是要知道自己要去哪里，无论对于小型爬虫，大规模爬虫或则分布式爬虫来说，都是如此。一只爬虫通常需要维护一个任务队列和一个地址集合，要做的事情主要是下面的三步：</p>
<p>1.从任务列表中去到一个地址，访问并下载该网页<br>2.分析网页，从中提取内容和发现新的地址<br>3.判断地址是否在集合当中，如果不在则添加到任务队列中</p>
<p>推荐教程：<br><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000</a><br><a href="http://cuiqingcai.com/1052.html" target="_blank" rel="external">http://cuiqingcai.com/1052.html</a></p>
<h1 id="程序说明"><a href="#程序说明" class="headerlink" title="程序说明"></a>程序说明</h1><p>这个程序主要是访问北邮教务处，提取其中课表和成绩。程序使用了requests包进行网页访问和下载，BS4进行页面解析，pytesseract来识别验证码，prettytable来规范输出字符表格。</p>
<p>程序需在北邮内网中使用，且需要安装谷歌的ocr库tesseract（在mac上安装很方便，win下略麻烦），下面是安装教程地址：<br><a href="https://github.com/tesseract-ocr/tesseract/wiki" target="_blank" rel="external">https://github.com/tesseract-ocr/tesseract/wiki</a></p>
<h1 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h1><p><img src="http://i2.buimg.com/567571/e7d2133a5274013e.png" alt="课程表"></p>
<p><img src="http://i2.buimg.com/567571/03ce7b4366d7c4b4.png" alt="成绩查询"></p>
<p><img src="http://i2.buimg.com/567571/59e8713cc43c3ed7.png" alt="课程搜索"></p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>代码比较烂，见笑了</p>
<p><a href="https://github.com/dong100136/PracticeCode/tree/master/python-spyer" target="_blank" rel="external">程序源码</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pytesseract使用</span></span><br><span class="line">img = Image.open(<span class="string">"./img.jpg"</span>)</span><br><span class="line">imgCode = pytesseract.image_to_string(img)</span><br><span class="line"></span><br><span class="line"><span class="comment">#requests</span></span><br><span class="line">session = requests.Session()</span><br><span class="line">url = <span class="string">"http://jwxt.bupt.edu.cn/gradeLnAllAction.do?type=ln&amp;oper=sxinfo&amp;lnsxdm=001"</span></span><br><span class="line">webPage = session.get(url)</span><br><span class="line"></span><br><span class="line"><span class="comment">#urllib</span></span><br><span class="line">cj=cookielib.CookieJar()</span><br><span class="line">opener=urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))</span><br><span class="line">urllib2.install_opener(opener)</span><br><span class="line"></span><br><span class="line"><span class="comment">#BS4</span></span><br><span class="line"><span class="keyword">from</span> beautifulsoup <span class="keyword">import</span> BeautifulSoup <span class="keyword">as</span> BS</span><br><span class="line">soup = BS(r.content, <span class="string">'html.parser'</span>)</span><br><span class="line">table = soup.find_all(<span class="string">"td"</span>, class_=<span class="string">"pageAlign"</span>)[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#prettytable</span></span><br><span class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> PrettyTable <span class="keyword">as</span> PT</span><br><span class="line">table = PT([<span class="string">'课程名字'</span>, <span class="string">'教师'</span>, <span class="string">'上课周'</span>, <span class="string">'星期'</span>, <span class="string">'上课时间'</span>, <span class="string">'节数'</span>,<span class="string">'课室'</span> ,<span class="string">'学分'</span>, <span class="string">'类型'</span>])</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> class_table:</span><br><span class="line">    table.add_row(</span><br><span class="line">        [item[<span class="string">'name'</span>], item[<span class="string">'teacher'</span>], item[<span class="string">'week'</span>], item[<span class="string">'weekday'</span>], item[<span class="string">'time'</span>], item[<span class="string">'long'</span>], item[<span class="string">'room'</span>],item[<span class="string">'point'</span>],</span><br><span class="line">		     item[<span class="string">'type'</span>]])</span><br><span class="line"></span><br><span class="line">print(table)</span><br></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://dong100136.github.io/2016/09/03/【python爬虫】北邮教务系统/" data-id="civtntdvy00086vwhe238qn6s" class="article-share-link">Aktie</a><div class="tags"><a href="/tags/python-爬虫/">python 爬虫</a></div><div class="post-nav"><a href="/2016/09/03/【python】学习小记（持续跟新）/" class="pre">【python】学习小记（持续跟新）</a><a href="/2016/05/11/gitlab的安装,备份与恢复/" class="next">gitlab的安装，备份与恢复</a></div></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://dong100136.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Kategorien</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/python-爬虫/" style="font-size: 15px;">python 爬虫</a> <a href="/tags/php/" style="font-size: 15px;">php</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/22/java-scala-reflect/">java反射机制学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/20/spacemacs-org/">spacemacs使用小记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/20/python-chatroom/">python-chatroom</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/02/用git搭建自动发布的服务器/">用git搭建自动发布的服务器</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/27/【数据库】设计范式/">【数据库】设计范式</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/08/【CaaS】k8s创建资源yaml详解/">【CaaS】k8s创建资源yaml详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/03/【python】学习小记（持续跟新）/">【python】学习小记（持续跟新）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/03/【python爬虫】北邮教务系统/">【python爬虫】北邮教务系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/11/gitlab的安装,备份与恢复/">gitlab的安装，备份与恢复</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://github.com/dong100136" title="github主页" target="_blank">github主页</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Stone@bupt.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>